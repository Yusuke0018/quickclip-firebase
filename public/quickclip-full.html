<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickClip Firebase - スマート定型文管理</title>
    
    <!-- Firebase v9 compatibility mode -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background-color: #fff;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #e5e5e5;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
        }
        
        /* Sidebar */
        .sidebar {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            height: fit-content;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .category-list {
            list-style: none;
            margin-top: 1rem;
        }
        
        .category-item {
            padding: 0.75rem;
            margin: 0.25rem 0;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        
        .category-edit-btn {
            position: absolute;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .category-item:hover .category-edit-btn {
            opacity: 1;
        }
        
        .category-item:hover {
            background-color: #f0f0f0;
        }
        
        .category-item.active {
            background-color: #2563eb;
            color: white;
        }
        
        .category-icon {
            width: 20px;
            height: 20px;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }
        
        /* Main content */
        .main-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .snippets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .snippet-card {
            background-color: #f9f9f9;
            padding: 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            position: relative;
            border: 1px solid #e5e5e5;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .snippet-card:active {
                transform: scale(0.98);
                background-color: #e5e5e5;
            }
        }
        
        .snippet-card:hover {
            background-color: #f0f0f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .snippet-card:hover .snippet-actions {
            opacity: 1;
        }
        
        .snippet-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .snippet-content {
            color: #666;
            font-size: 0.875rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        
        .snippet-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn:hover {
            background-color: #e0e0e0;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .btn-icon {
            padding: 0.5rem;
            background-color: transparent;
            color: #666;
        }
        
        .btn-icon:hover {
            background-color: #e5e5e5;
            color: #333;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #666;
        }
        
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.5rem;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            color: #333;
            font-size: 0.875rem;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        /* Utilities */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        
        .pin-icon {
            color: #fbbf24;
        }
        
        .success-message {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.375rem;
            animation: slideIn 0.3s ease-out;
            z-index: 1001;
        }
        
        @media (max-width: 768px) {
            .success-message {
                bottom: 50%;
                left: 50%;
                right: auto;
                transform: translate(-50%, 50%);
                font-size: 1.125rem;
                padding: 1.5rem 2rem;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .spinner {
            border: 2px solid #e5e5e5;
            border-top-color: #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .container {
                grid-template-columns: 1fr;
                padding: 1rem 0.5rem;
                gap: 1rem;
            }
            
            .sidebar {
                display: none;
            }
            
            .sidebar.mobile-active {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #fff;
                z-index: 999;
                overflow-y: auto;
                padding: 1rem;
            }
            
            .mobile-menu-btn {
                display: block;
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                width: 60px;
                height: 60px;
                background-color: #2563eb;
                color: white;
                border-radius: 50%;
                border: none;
                font-size: 1.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 998;
            }
            
            .mobile-menu-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #e5e5e5;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .snippets-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .snippet-card {
                padding: 0.75rem;
            }
            
            .snippet-actions {
                opacity: 1;
                position: static;
                margin-top: 0.5rem;
                display: flex;
                justify-content: flex-end;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
            
            .mobile-category-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                padding: 0.25rem 0.5rem;
                background-color: #f0f0f0;
                border-radius: 0.25rem;
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .mobile-only {
                display: block !important;
            }
            
            .desktop-only {
                display: none !important;
            }
        }
        
        /* Hide mobile elements on desktop */
        .mobile-menu-btn {
            display: none;
        }
        
        .mobile-menu-header {
            display: none;
        }
        
        .mobile-only {
            display: none;
        }
        
        /* Touch-friendly sizes */
        @media (max-width: 768px) {
            .btn-icon {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .category-item {
                padding: 1rem;
            }
            
            .form-input, .form-textarea, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
            }
            
            input[type="search"] {
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* モバイルで検索とタイトルを縦に配置 */
            @media (max-width: 480px) {
                main > div:first-child {
                    flex-direction: column;
                    gap: 0.75rem;
                }
                
                main input[type="search"] {
                    max-width: 100% !important;
                    width: 100%;
                }
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="snippetModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header" id="modalTitle">新規定型文</h2>
            <form id="snippetForm">
                <div class="form-group">
                    <label class="form-label">タイトル</label>
                    <input type="text" id="snippetTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">カテゴリー</label>
                    <select id="snippetCategory" class="form-select" required>
                        <!-- Categories will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">内容</label>
                    <textarea id="snippetContent" class="form-textarea" required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Edit Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">カテゴリーを編集</h2>
            <form id="categoryForm">
                <div class="form-group">
                    <label class="form-label">カテゴリー名</label>
                    <input type="text" id="categoryName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">アイコン</label>
                    <input type="text" id="categoryIcon" class="form-input" placeholder="絵文字を入力" required>
                </div>
                <div class="form-group">
                    <label class="form-label">カラー</label>
                    <input type="color" id="categoryColor" class="form-input" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteCategory()">削除</button>
                    <button type="button" class="btn" onclick="closeCategoryModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjrzvuPGmNrQuqzBnN_y5xDStCU-y5HlM",
            authDomain: "quickclip-4446c.firebaseapp.com",
            projectId: "quickclip-4446c",
            storageBucket: "quickclip-4446c.firebasestorage.app",
            messagingSenderId: "31602504581",
            appId: "1:31602504581:web:c80fe6bf2a0e60c281caec",
            measurementId: "G-H0GXNRP5TW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Global state
        let currentUser = null;
        let categories = [];
        let snippets = [];
        let selectedCategory = null;
        let editingSnippet = null;
        let editingCategory = null;
        let searchQuery = '';

        // Default categories
        const defaultCategories = [
            { name: 'パスワード', icon: '🔑', color: '#ef4444', order: 0 },
            { name: 'プロンプト', icon: '💻', color: '#a855f7', order: 1 },
            { name: '医療定型文', icon: '❤️', color: '#3b82f6', order: 2 },
            { name: 'メール署名', icon: '✉️', color: '#10b981', order: 3 },
            { name: 'スタッフ連絡', icon: '👥', color: '#f97316', order: 4 }
        ];

        // Auth state listener
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                await initializeUserData(user.uid);
                renderApp();
            } else {
                renderLoginScreen();
            }
        });

        // Initialize user data
        async function initializeUserData(userId) {
            try {
                // Check if user has categories
                const categoriesSnapshot = await db.collection('users').doc(userId).collection('categories').get();
                
                if (categoriesSnapshot.empty) {
                    // Create default categories for new user
                    for (const category of defaultCategories) {
                        await db.collection('users').doc(userId).collection('categories').add({
                            ...category,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                
                // Load user data
                await loadUserData(userId);
                
                // Check for local storage migration
                const hasLocalData = localStorage.getItem('quickclip_categories') || localStorage.getItem('quickclip_snippets');
                if (hasLocalData) {
                    if (confirm('ローカルに保存されたデータが見つかりました。クラウドに移行しますか？')) {
                        await migrateFromLocalStorage(userId);
                    }
                }
            } catch (error) {
                console.error('Error initializing user data:', error);
            }
        }

        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                // Load categories
                const categoriesSnapshot = await db.collection('users').doc(userId).collection('categories')
                    .orderBy('order', 'asc').get();
                categories = categoriesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load snippets
                const snippetsSnapshot = await db.collection('users').doc(userId).collection('snippets')
                    .orderBy('createdAt', 'desc').get();
                snippets = snippetsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Migrate from local storage
        async function migrateFromLocalStorage(userId) {
            try {
                const localCategories = JSON.parse(localStorage.getItem('quickclip_categories') || '[]');
                const localSnippets = JSON.parse(localStorage.getItem('quickclip_snippets') || '[]');
                
                // Create a mapping of old category IDs to new ones
                const categoryIdMap = {};
                
                // Migrate categories
                for (const category of localCategories) {
                    const docRef = await db.collection('users').doc(userId).collection('categories').add({
                        name: category.name,
                        icon: category.icon || '📁',
                        color: category.color || '#3b82f6',
                        order: category.order || 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    categoryIdMap[category.id] = docRef.id;
                }
                
                // Migrate snippets
                for (const snippet of localSnippets) {
                    await db.collection('users').doc(userId).collection('snippets').add({
                        title: snippet.title,
                        content: snippet.content,
                        categoryId: categoryIdMap[snippet.categoryId] || categories[0]?.id,
                        isPinned: snippet.pinned || false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Clear local storage
                localStorage.removeItem('quickclip_categories');
                localStorage.removeItem('quickclip_snippets');
                
                // Reload data
                await loadUserData(userId);
                showSuccess('データを正常に移行しました');
            } catch (error) {
                console.error('Migration error:', error);
                alert('データ移行中にエラーが発生しました');
            }
        }

        // Render functions
        function renderLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
                    <div style="background-color: #fff; padding: 2rem; border-radius: 0.5rem; text-align: center; max-width: 400px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);">
                        <h1 style="font-size: 2rem; margin-bottom: 1rem; color: #333;">QuickClip</h1>
                        <p style="color: #666; margin-bottom: 2rem;">定型文をクラウドで管理</p>
                        <button onclick="signIn()" class="btn btn-primary" style="width: 100%;">
                            Googleでログイン
                        </button>
                    </div>
                </div>
            `;
        }

        function renderApp() {
            let filteredSnippets = selectedCategory 
                ? snippets.filter(s => s.categoryId === selectedCategory)
                : snippets;
            
            // 検索フィルター
            if (searchQuery) {
                filteredSnippets = filteredSnippets.filter(s => 
                    s.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    s.content.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }
            
            // Sort snippets: pinned first
            filteredSnippets.sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return 0;
            });

            document.getElementById('app').innerHTML = `
                <!-- Header -->
                <header class="header">
                    <div class="header-content">
                        <h1 class="logo">QuickClip</h1>
                        <div class="user-info">
                            <button onclick="exportData()" class="btn" title="エクスポート">📥 エクスポート</button>
                            <label class="btn" style="cursor: pointer;" title="インポート">
                                📤 インポート
                                <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                            </label>
                            <span>${currentUser.email}</span>
                            <button onclick="signOut()" class="btn btn-danger">ログアウト</button>
                        </div>
                    </div>
                </header>

                <!-- Main Container -->
                <div class="container">
                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <button onclick="openModal()" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                            ＋ 新規追加
                        </button>
                        
                        <div class="mobile-menu-header">
                            <h2 style="font-size: 1.25rem; font-weight: 600;">メニュー</h2>
                            <button onclick="closeMobileMenu()" class="btn-icon" style="font-size: 1.5rem;">×</button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h2 style="font-size: 1.125rem; font-weight: 600;">カテゴリー</h2>
                            <button onclick="openCategoryModal()" class="btn-icon" title="カテゴリー追加">
                                ＋
                            </button>
                        </div>
                        <ul class="category-list">
                            <li class="category-item ${!selectedCategory ? 'active' : ''}" onclick="selectCategory(null)">
                                <span class="category-icon" style="background-color: #4b5563;">📋</span>
                                <span>すべて (${snippets.length})</span>
                            </li>
                            ${categories.map(category => `
                                <li class="category-item ${selectedCategory === category.id ? 'active' : ''}" 
                                    onclick="selectCategory('${category.id}')">
                                    <span class="category-icon" style="background-color: ${category.color};">
                                        ${category.icon}
                                    </span>
                                    <span style="flex: 1;">${category.name} (${snippets.filter(s => s.categoryId === category.id).length})</span>
                                    <button class="btn-icon category-edit-btn" onclick="event.stopPropagation(); editCategory('${category.id}')" title="編集">
                                        ✏️
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    </aside>

                    <!-- Mobile Menu Button -->
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                        ☰
                    </button>
                    
                    <!-- Mobile Add Button -->
                    <button class="mobile-menu-btn mobile-add-btn" onclick="openModal()" style="bottom: 5rem; background-color: #10b981;">
                        ＋
                    </button>

                    <!-- Main Content -->
                    <main class="main-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="font-size: 1.5rem; font-weight: 600; margin: 0;">
                                <span class="desktop-only">${selectedCategory ? categories.find(c => c.id === selectedCategory)?.name || 'すべて' : 'すべての定型文'}</span>
                                <button onclick="toggleMobileMenu()" class="btn btn-primary mobile-only">
                                    カテゴリーを選択
                                </button>
                            </h2>
                            <input type="search" 
                                   placeholder="検索..." 
                                   class="form-input" 
                                   style="max-width: 300px; margin: 0;"
                                   value="${searchQuery}"
                                   onchange="searchSnippets(this.value)"
                                   oninput="searchSnippets(this.value)">
                        </div>
                        
                        ${filteredSnippets.length === 0 ? `
                            <div class="empty-state">
                                <p style="font-size: 1.125rem; margin-bottom: 1rem;">定型文がありません</p>
                                <button onclick="openModal()" class="btn btn-primary">新しい定型文を追加</button>
                            </div>
                        ` : `
                            <div class="snippets-grid">
                                ${filteredSnippets.map(snippet => {
                                    const category = categories.find(c => c.id === snippet.categoryId);
                                    return `
                                        <div class="snippet-card" onclick="handleSnippetClick(event, '${snippet.id}')">
                                            <div class="mobile-category-badge mobile-only">
                                                ${category ? `<span style="color: ${category.color};">${category.icon}</span>` : ''}
                                                <span>${category?.name || 'カテゴリーなし'}</span>
                                            </div>
                                            <div class="snippet-title">
                                                <span class="desktop-only">${category ? `<span style="color: ${category.color};">${category.icon}</span>` : ''}</span>
                                                <span>${snippet.title}</span>
                                                ${snippet.isPinned ? '<span class="pin-icon">⭐</span>' : ''}
                                            </div>
                                            <div class="snippet-content">${snippet.content}</div>
                                            <div class="snippet-actions">
                                                <button class="btn-icon" onclick="togglePin('${snippet.id}')" title="ピン留め">
                                                    ${snippet.isPinned ? '⭐' : '☆'}
                                                </button>
                                                <button class="btn-icon" onclick="copyToClipboard('${snippet.content.replace(/'/g, "\\'")}')" title="コピー">
                                                    📋
                                                </button>
                                                <button class="btn-icon" onclick="editSnippet('${snippet.id}')" title="編集">
                                                    ✏️
                                                </button>
                                                <button class="btn-icon" onclick="deleteSnippet('${snippet.id}')" title="削除">
                                                    🗑️
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </main>
                </div>
            `;
        }

        // UI Functions
        function selectCategory(categoryId) {
            selectedCategory = categoryId;
            renderApp();
            // モバイルの場合はメニューを閉じる
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
        }
        
        // Mobile menu functions
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.toggle('mobile-active');
            }
        }
        
        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('mobile-active');
            }
        }
        
        function handleSnippetClick(event, snippetId) {
            // モバイルでカード全体をタップしたときにコピー
            if (window.innerWidth <= 768 && !event.target.closest('.btn-icon')) {
                const snippet = snippets.find(s => s.id === snippetId);
                if (snippet) {
                    copyToClipboard(snippet.content);
                }
            }
        }
        
        function searchSnippets(query) {
            searchQuery = query;
            renderApp();
        }

        function openModal(snippetId = null) {
            editingSnippet = snippetId ? snippets.find(s => s.id === snippetId) : null;
            
            document.getElementById('modalTitle').textContent = editingSnippet ? '定型文を編集' : '新規定型文';
            document.getElementById('snippetTitle').value = editingSnippet?.title || '';
            document.getElementById('snippetContent').value = editingSnippet?.content || '';
            
            // Populate categories
            const categorySelect = document.getElementById('snippetCategory');
            categorySelect.innerHTML = categories.map(category => `
                <option value="${category.id}" ${editingSnippet?.categoryId === category.id ? 'selected' : ''}>
                    ${category.icon} ${category.name}
                </option>
            `).join('');
            
            if (!editingSnippet && selectedCategory) {
                categorySelect.value = selectedCategory;
            }
            
            document.getElementById('snippetModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('snippetModal').classList.remove('active');
            editingSnippet = null;
        }

        function editSnippet(snippetId) {
            openModal(snippetId);
        }

        async function deleteSnippet(snippetId) {
            if (!confirm('この定型文を削除しますか？')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('snippets').doc(snippetId).delete();
                await loadUserData(currentUser.uid);
                renderApp();
                showSuccess('定型文を削除しました');
            } catch (error) {
                console.error('Error deleting snippet:', error);
                alert('削除中にエラーが発生しました');
            }
        }

        async function togglePin(snippetId) {
            const snippet = snippets.find(s => s.id === snippetId);
            if (!snippet) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('snippets').doc(snippetId).update({
                    isPinned: !snippet.isPinned
                });
                await loadUserData(currentUser.uid);
                renderApp();
            } catch (error) {
                console.error('Error toggling pin:', error);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('コピーしました');
            }).catch(err => {
                console.error('Copy failed:', err);
                // Fallback method
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showSuccess('コピーしました');
            });
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Form submission
        document.getElementById('snippetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('snippetTitle').value;
            const content = document.getElementById('snippetContent').value;
            const categoryId = document.getElementById('snippetCategory').value;
            
            try {
                if (editingSnippet) {
                    // Update existing snippet
                    await db.collection('users').doc(currentUser.uid).collection('snippets').doc(editingSnippet.id).update({
                        title,
                        content,
                        categoryId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showSuccess('定型文を更新しました');
                } else {
                    // Create new snippet
                    await db.collection('users').doc(currentUser.uid).collection('snippets').add({
                        title,
                        content,
                        categoryId,
                        isPinned: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showSuccess('定型文を追加しました');
                }
                
                await loadUserData(currentUser.uid);
                closeModal();
                renderApp();
            } catch (error) {
                console.error('Error saving snippet:', error);
                alert('保存中にエラーが発生しました');
            }
        });

        // Export/Import functions
        async function exportData() {
            try {
                const exportData = {
                    version: '1.0',
                    exportedAt: new Date().toISOString(),
                    categories: categories,
                    snippets: snippets
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quickclip-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showSuccess('データをエクスポートしました');
            } catch (error) {
                console.error('Export error:', error);
                alert('エクスポートに失敗しました');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!data.categories || !data.snippets) {
                    throw new Error('無効なデータ形式です');
                }
                
                const confirmMsg = `${data.categories.length}個のカテゴリーと${data.snippets.length}個の定型文をインポートします。\n既存のデータに追加されます。続行しますか？`;
                if (!confirm(confirmMsg)) return;
                
                // Import categories
                const categoryIdMap = {};
                for (const category of data.categories) {
                    const oldId = category.id;
                    const docRef = await db.collection('users').doc(currentUser.uid).collection('categories').add({
                        name: category.name,
                        icon: category.icon || '📁',
                        color: category.color || '#3b82f6',
                        order: category.order || categories.length,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    categoryIdMap[oldId] = docRef.id;
                }
                
                // Import snippets
                for (const snippet of data.snippets) {
                    const categoryId = categoryIdMap[snippet.categoryId] || snippet.categoryId || categories[0]?.id;
                    await db.collection('users').doc(currentUser.uid).collection('snippets').add({
                        title: snippet.title,
                        content: snippet.content,
                        categoryId: categoryId,
                        isPinned: snippet.isPinned || snippet.pinned || false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Reload data
                await loadUserData(currentUser.uid);
                renderApp();
                showSuccess('データをインポートしました');
                
                // Reset file input
                event.target.value = '';
            } catch (error) {
                console.error('Import error:', error);
                alert('インポートに失敗しました: ' + error.message);
            }
        }

        // Category functions
        function openCategoryModal() {
            editingCategory = null;
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryIcon').value = '';
            document.getElementById('categoryColor').value = '#3b82f6';
            document.getElementById('categoryModal').classList.add('active');
        }
        
        function editCategory(categoryId) {
            editingCategory = categories.find(c => c.id === categoryId);
            if (!editingCategory) return;
            
            document.getElementById('categoryName').value = editingCategory.name;
            document.getElementById('categoryIcon').value = editingCategory.icon;
            document.getElementById('categoryColor').value = editingCategory.color;
            document.getElementById('categoryModal').classList.add('active');
        }
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            editingCategory = null;
        }
        
        async function deleteCategory() {
            if (!editingCategory) return;
            
            // カテゴリーに属する定型文があるかチェック
            const categorySnippets = snippets.filter(s => s.categoryId === editingCategory.id);
            if (categorySnippets.length > 0) {
                alert(`このカテゴリーには${categorySnippets.length}個の定型文があります。先に定型文を削除するか、他のカテゴリーに移動してください。`);
                return;
            }
            
            if (!confirm('このカテゴリーを削除しますか？')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).collection('categories').doc(editingCategory.id).delete();
                await loadUserData(currentUser.uid);
                closeCategoryModal();
                renderApp();
                showSuccess('カテゴリーを削除しました');
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('削除中にエラーが発生しました');
            }
        }
        
        // Category form submission
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('categoryName').value;
            const icon = document.getElementById('categoryIcon').value;
            const color = document.getElementById('categoryColor').value;
            
            try {
                if (editingCategory) {
                    // Update existing category
                    await db.collection('users').doc(currentUser.uid).collection('categories').doc(editingCategory.id).update({
                        name,
                        icon,
                        color,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showSuccess('カテゴリーを更新しました');
                } else {
                    // Create new category
                    await db.collection('users').doc(currentUser.uid).collection('categories').add({
                        name,
                        icon,
                        color,
                        order: categories.length,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showSuccess('カテゴリーを追加しました');
                }
                
                await loadUserData(currentUser.uid);
                closeCategoryModal();
                renderApp();
            } catch (error) {
                console.error('Error saving category:', error);
                alert('保存中にエラーが発生しました');
            }
        });

        // Auth functions
        function signIn() {
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('Login successful:', result.user.email);
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    alert('ログインに失敗しました: ' + error.message);
                });
        }

        function signOut() {
            if (confirm('ログアウトしますか？')) {
                auth.signOut()
                    .then(() => {
                        console.log('Signed out successfully');
                    })
                    .catch((error) => {
                        console.error('Sign out error:', error);
                    });
            }
        }
    </script>
</body>
</html>